## 6.6 分布式概述

>date: 2019-12-23

![](../assets/images/66.jpg)

### 6.6.1 `CAP`理论

![CAP理论](../assets/images/661_01.png)

1. 一致性(`C：Consistency`)

**一致性**是指所有节点在同一时刻的数据是相同的，即更新操作执行结束并响应用户完成后，所有节点存储的数据会保持相同。

在分布式环境下，一致性是指数据在多个副本之间能否保持一致的特性。在一致性的需求下，当一个系统在数据一致的状态下执行更新操作后，应该保证系统的数据仍然处于一致的状态。

在分布式系统中，如果能够做到针对一个数据项的更新操作执行成功后，所有的用户都可以读取到其最新的值，那么这样的系统就被认为具有**强一致性**。

2、可用性(`A：Availability`)

可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。这里的重点是**有限时间内**和**返回结果**。

**有限时间内**是指，对于用户的一个操作请求，系统必须能够在指定的时间内返回对应的处理结果，如果超过了这个时间范围，那么系统就被认为是不可用的。

另外，**有限时间内**是指系统设计之初就设计好的运行指标，通常不同系统之间有很 大的不同，无论如何，对于用户请求，系统必须存在一个合理的响应时间，否则用户便会对系统感到失望。

**返回结果**是可用性的另一个非常重要的指标，它要求系统在完成对用户请求的处理后，返回一个正常的响应结果。正常的响应结果通常能够明确地反映出队请求的处理结果，即成功或失败，而不是一个让用户感到困惑的返回结果。

3、分区容错性(`P：Partition tolerance`)

分区容错性约束了一个分布式系统具有如下特性：分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。

网络分区是指在分布式系统中，不同的节点分布在不同的子网络（机房或异地网络） 中，由于一些特殊的原因导致这些子网络出现网络不连通的状况，但各个子网络的内部网络是正常的，从而导致整个系统的网络环境被切分成了若干个孤立的区域。需要注意的是，组成一个分布式系统的每个节点的加入与退出都可以看作是一个特殊的网络分区。

一个分布式系统不可能同时满足一致性(`C：Consistency`)、可用性(`A：Availability`)和分区容错性(`P：Partition tolerance`)这三个基本需求，最多只能同时满足其中两项。

**放弃`P`**：

如果希望能够避免系统出现分区容错性问题，一种较为简单的做法是将所有的数据（或者仅仅是哪些与事务相关的数据）都放在一个分布式节点上。这样做虽然无法100%保证系统不会出错，但至少不会碰到由于网络分区带来的负面影响。但同时需要注意的是，放弃P的同时也就意味着放弃了系统的可扩展性。

**放弃`A`**：

一旦系统遇到网络分区或其他故障或为了保证一致性时，放弃可用性，那么受到影响的服务需要等待一定的时间，因此在等待期间系统无法对外提供正常的服务，即不可用。

**放弃`C`**：

这里所说的放弃一致性，实际上指的是放弃数据的强一致性，而保留数据的最终一致性。这样的系统无法保证数据保持实时的一致性，但是能够承诺的是，数据最终会达到一个一致的状态。

### 6.6.2 分布式数据存储系统

分布式存储系统的核心逻辑，就是将用户需要存储的数据根据某种规则存储到不同机器上，当用户想要获取指定数据时候，再按照规则到存储数据的机器上获取。

* **分布式存储系统三要素**

![获取数据流程](../assets/images/662_01.png)

当应用程序需要访问某些数据时候，分布式操作引擎会根据一些映射规则，从存储的节点上获取指定的数据。

上面的过程就涉及到了分布式存储系统的三要素：**数据生产者/消费者**、**数据索引**、**数据存储**。

**数据生产者/消费者**：生产者负责给存储系统添加数据，而消费者则可以使用系统中存储的数据。

而不同应用场景中数据的类型、格式等都不一样。根据数据的特征，这些不同的数据通常被划分为三类：**结构化数据**、**半结构化数据**和**非结构化数据**：

- 1) **结构化数据**通常是指关系模型数据，其特征是数据关联较大、格式固定。其具有格式固定的特征，因此一般采用分布式关系数据库进行存储和查询；

- 2) **半结构化数据**通常是指非关系模型的，有基本固定结构模式的数据，其特征是数据之间关系比较简单。半结构化数据大多可以采用键值对形式来表示，一般采用分布式键值系统进行存储和使用。

- 3) **非结构化数据**是指没有固定模式的数据，其特征是数据之间关联不大。比如文本数据就是一种非结构化数据。这种数据可以存储到文档中，通过相关检索引擎进行检索。

* **数据索引和数据分布**

**数据索引**：分布式存储系统中，必须有响应的数据索引规则，不然系统的响应就会非常慢，效率很低。

**数据分布**主要是数据分布，而**数据分片技术**就是将分布式存储系统中的数据按照一定的规则将数据存储到相对应的存储节点中，同样，按照这个规则也能从相对应的节点中获取数据。

这个技术一方面需要降低单个存储节点的存储和访问压力，一方面需要有相关的规则来快速索引数据，降低搜索延迟，提高用户体验。

常见的数据分片方案有：数据范围、哈希映射、一致性哈希环等。

- * 存储选型

存储方案选型：在分布式数据存储系统中，存储方案选型时，通常会考虑**数据均匀、数据稳定和节点异构性**这三个维度。

- 1) **数据均匀**：不同存储节点中存储的数据要尽量均衡，避免让某一个或某几个节点存储压力过大，而其他节点却几乎没什么数据；而用户访问时也需要均衡，避免出现某一个或某几个节点的访问量很大，但其他节点却没有访问的情况；

- 2) **数据稳定**：当存储节点出现故障需要移除或扩增时，数据按照分布规则得到的记过应该尽量保持稳定，不要出现大规模的数据迁移；

- 3) **节点异构性**：不同的存储节点的硬件配置可能差别很大，这本身就是一种不均衡，而在设计分布规则时，将这种节点异构性导致的不均衡考虑进去也是必须的。

另外还需要考虑诸如隔离故障域和性能稳定性等因素。

- 4) **隔离故障域**：保证数据的可用和可靠性；

- 5) **性能稳定性**：数据存储和查询的效率要有保证，不能因为节点的添加或者移除，造成存储或访问性能的严重下降。

- * 分布方法

- 1) **哈希**

**哈希**是常用的数据分布方法，核心思想就是确定一个哈希函数，然后通过计算得到对应的存储节点。

假设存在 `3` 个节点：`Node1`、`Node2`、`Node3`，哈希函数为`id % 节点个数`，其结果即该 `id` 存储的节点。

其最大的问题就是稳定性较差，如果随着数据量的增加，当前的节点容量已经无法满足存储需求了，就需要添加一个节点，而之前的哈希函数变成了 `id % 4` ，原本存储在 `3` 个节点的数据就需要重新计算，然后存入相应的节点。这就需要大规模的数据迁移，显然会降低系统稳定性。

综上，哈希方法适用于**同类型节点且节点数量比较固定的场景**。

- 2) **一致性哈希**

**一致性哈希**是指将存储节点和数据映射到一个首尾相连的**哈希环**上，存储节点可以根据 `IP` 地址进行哈希，数据通常通过顺时针方向寻找的方式，来确定自己所属的存储节点，即从数据映射在环上的位置开始，顺时针方向找到的第一个存储节点。

一致性哈希是对哈希方法的改进，其在数据存储前，对存储节点预先进行了哈希，然后在数据存储的时候，也采用哈希的方式来确定存储的节点位置。

这种改进能很好地解决上面哈希方法中存在的稳定性问题。因为在节点增加或退出时，只会影响到相邻的后继节点。

当然，这种改进同样带来的问题也是很明显的，如果有节点退出了，那么后继节点负载也会增大，导致节点的数据均匀不均衡了，后继节点也会承担更大的压力。

综上，一致性哈希方法比较适合**同类型节点、节点规模会发生变化的场景**。

- 3) **带有限负载的一致性哈希**

**带有限负载的一致性哈希**是指给每个存储节点设置了一个存储上限值来控制存储节点添加或移除造成的数据不均匀。

当数据按照一致性哈希算法找到相应的存储节点时，要先判断该存储节点是否达到了存储上限；如果已经达到了上限，则需要继续寻找该存储节点顺时针方向之后的节点进行存储。

综上，带有限负载的一致性哈希方法比较适合同类型节点、节点规模会发生变化的场景。

而**哈希、一致性哈希、带有限负载的一致性哈希**都没有考虑**节点异构性**的问题。如果存储节点的性能好坏不一，数据分布方案还按照这些方法的话，其实还是没做到数据的均匀分布。

- 4) **带虚拟节点的一致性哈希**

**带虚拟节点的一致性哈希方法**是指根据每个节点的性能，为每个节点划分不同数量的虚拟节点，并将这些虚拟节点映射到哈希环中，然后再按照一致性哈希算法进行数据映射和存储。

带虚拟节点的一致性哈希方法比较适合**异构节点、节点规模会发生变化的场景**。

这种方法不仅解决了节点异构性问题，还提高了系统的稳定性。当节点变化时，会有多个节点共同分担系统的变化，因此稳定性更高。

当然，这种方法引入了虚拟节点，增加了节点规模，从而增加了节点的维护和管理的复杂度。

* **数据复制**

**数据复制**是一个非常重要的方法，其将数据备份到多个节点，以提高系统的可用性和可靠性。

在实际的分布式存储系统中，数据分片和数据复制通常是共存的：

- * 数据通过分片方式存储到不同的节点上，以减少单节点的性能瓶颈问题；

- * 数据的存储通常用主备方式保证可靠性，也就是对每个节点上存储的分片数据，采用主备方式存储，以保证数据的可靠性。其中，主备节点上数据的一致，是通过数据复制技术实现的。

