## 6.1 分布式系统

>date: 2019-05-06

![](../assets/images/61.jpg)

### 6.1.1 基础理论

分布式系统是作为单个完整服务展现在终端用户面前的一组协同工作服务器。组中的服务器共享状态、同步操作，并且任意某个服务器独立故障时都不会影响整个系统的正常运行。

* 分布式和集群

分布式：将一个业务员拆分不同的子业务，分布在不同的机器上执行；

集群：多台服务器集中在一起，实现同一业务，可以视为一台计算机。

但是分布式的每一个节点，都可以用来做集群，但是集群不一定是分布式的。

* `SOA`和微服务架构

`SOA`：面向服务的架构，这是一种设计理念，其中包含多个服务，服务之间通过相互依赖最终提供一系列完整的功能。

微服务：类似`SOA`架构，但是更加强调业务彻底的组件化和服务化，单个业务系统会被拆分为可以独立开发、设计、部署的小应用。

* `PV`、`TPS`、`QPS`

`PV`：访问量即`Page View`, 即页面浏览量或点击量，用户每次刷新即被计算一次。

单台服务器每天PV计算：`每天总PV = QPS * 3600 * 6`；`每天总PV = QPS * 3600 * 8`。

`TPS`：`Transactions Per Second`（每秒传输的事物处理个数），即服务器每秒处理的事务数。TPS包括一条消息入和一条消息出，加上一次用户数据库访问。`业务TPS = CAPS × 每个呼叫平均TPS`。

`TPS`是软件测试结果的测量单位。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数。一般的，评价系统性能均以每秒钟完成的技术交易的数量来衡量。系统整体处理能力取决于处理能力最低模块的`TPS`值。

`QPS`：每秒查询率`QPS`是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。对应`fetches/sec`，即每秒的响应请求数，也即是最大吞吐能力。

### 6.1.2 可伸缩和可扩展

* 垂直扩展和水平扩展

1. 垂直扩展：在系统现有的部件上下工夫，通过提高某个部件的性能（或速度）来提高负载能力的。

2. 水平扩展：通过增加更多的系统成员（性能或速度还是原来的一样）来提高负载能力的。

* 可伸缩

伸缩性是指在不改变原有架构设计的基础上，通过添加/减少硬件（服务器）的方式，提高/降低系统的处理能力。

1. 应用层：对应用进行垂直或水平切分。然后针对单一功能进行负载均衡（`DNS`,`HTTP`[反向代理],`IP`,链路层）。

2. 服务层：与应用层类似。

3. 数据层：分库，分表，`NOSQL`等；常用算法`Hash`，一致性`Hash`。

* 可扩展

可以方便的进行功能模块的新增/移除，提供代码/模块级别良好的可扩展性。

1. 模块化，组件化：高内聚，内耦合，提高复用性，扩展性。

2. 稳定接口：定义稳定的接口，在接口不变的情况下，内部结构可以“随意”变化。

3. 设计模式：应用面向对象思想，原则，使用设计模式，进行代码层面的设计。

4. 消息队列：模块化的系统，通过消息队列进行交互，使模块之间的依赖解耦。

5. 分布式服务：公用模块服务化，提供其他系统使用，提高可重用性，扩展性。

### 6.1.3 高可用

#### 负载均衡

负载均衡 （`Load Balance`），其意思就是将负载（工作任务）进行平衡、分摊到多个操作单元上进行执行。需要我们注意的是：它并不属于网络基础架构，而是属于一种网络优化设备。它是建立在现有的网络基础架构之上，给企业提供了更廉价更有效的扩展选择。

* 硬件

硬件负载均衡解决方案是直接在服务器和外部网络间安装负载均衡设备，这种设备我们通常称之为负载均衡器，由于专门的设 备完成专门的任务，独立于操作系统，整体性能得到大量提高，加上多样化的负载均衡策略，智能化的流量管理，可达到最佳的负载均衡需求。

优点：能够直接通过智能交换机实现,处理能力更强，而且与系统无关，负载性能强更适用于一大堆设备、大访问量、简单应用。

缺点：成本高，除设备价格高昂，而且配置冗余．很难想象后面服务器做一个集群，但最关键的负载均衡设备却是单点配置；无法有效掌握服务器及应用状态。
硬件负载均衡，一般都不管实际系统与应用的状态，而只是从网络层来判断，所以有时候系统处理能力已经不行了，但网络可能还来得及反应（这种情况非常典型，比如应用服务器后面内存已经占用很多，但还没有彻底不行，如果网络传输量不大就未必在网络层能反映出来）。

* 软件

软件负载均衡解决方案是指在一台或多台服务器相应的操作系统上安装一个或多个附加软件来实现负载均衡，它的优点是基于特定环境，配置简单，使用灵活，成本低廉，可以满足一般的负载均衡需求。

目前比较流行的就三类软件负载均衡，`LVS`、`Nginx`和`HAProxy`。用的最多的还是`LVS`和`Nginx`这两种。

优点：基于系统与应用的负载均衡，能够更好地根据系统与应用的状况来分配负载。这对于复杂应用是很重要的，性价比高，实际上如果几台服务器，用F5之类的硬件产品显得有些浪费，而用软件就要合算得多，因为服务器同时还可以跑应用做集群等。

缺点：负载能力受服务器本身性能的影响，性能越好，负载能力越大。

* 负载均衡算法

1. 静态负载均衡算法

轮询（`Round Robin`）：顺序循环将请求一次顺序循环地连接每个服务器。当其中某个服务器发生第二到第七层的故障，`BIG-IP` 就把其从顺序循环队列中拿出，不参加下一次的轮询，直到其恢复正常。

比率（`Ratio`）：给每个服务器分配一个加权值为比例，根椐这个比例，把用户的请求分配到每个服务器。当其中某个服务器发生第二到第七层的故障，`BIG-IP` 就把其从服务器队列中拿出，不参加下一次的用户请求的分配, 直到其恢复正常。

优先权（`Priority`）：给所有服务器分组,给每个组定义优先权，`BIG-IP` 用户的请求，分配给优先级最高的服务器组（在同一组内，采用轮询或比率算法，分配用户的请求）；当最高优先级中所有服务器出现故障，`BIG-IP` 才将请求送给次优先级的服务器组。这种方式，实际为用户提供一种热备份的方式。

2. 动态负载均衡算法

最少的连接方式（`Least Connection`）：传递新的连接给那些进行最少连接处理的服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP 就把其从服务器队列中拿出，不参加下一次的用户请求的分配, 直到其恢复正常。

最快模式（`Fastest`）：传递连接给那些响应最快的服务器。当其中某个服务器发生第二到第7 层的故障，`BIG-IP` 就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

观察模式（`Observed`）：连接数目和响应时间以这两项的最佳平衡为依据为新的请求选择服务器。当其中某个服务器发生第二到第7 层的故障，BIG-IP就把其从服务器队列中拿出，不参加下一次的用户请求的分配，直到其恢复正常。

预测模式（`Predictive`）：`BIG-IP`利用收集到的服务器当前的性能指标，进行预测分析，选择一台服务器在下一个时间片内，其性能将达到最佳的服务器相应用户的请求。(被`BIG-IP` 进行检测)

动态性能分配(`Dynamic Ratio-APM`):`BIG-IP` 收集到的应用程序和应用服务器的各项性能参数，动态调整流量分配。

动态服务器补充(D`ynamic Server Act`):当主服务器群中因故障导致数量减少时，动态地将备份服务器补充至主服务器群。

服务质量(`QoS`）:按不同的优先级对数据流进行分配。

服务类型(`ToS`): 按不同的服务类型（在`Type of Field`中标识）负载均衡对数据流进行分配。

规则模式：针对不同的数据流设置导向规则，用户可自行。

#### 缓存

#### 降级

服务降级是当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级，以此释放服务器资源以保证核心任务的正常运行。降级往往会指定不同的级别，面临不同的异常等级执行不同的处理。根据服务方式：可以拒接服务，可以延迟服务，也有时候可以随机服务。根据服务范围：可以砍掉某个功能，也可以砍掉某些模块。总之服务降级需要根据不同的业务需求采用不同的降级策略。主要的目的就是服务虽然有损但是总比没有好。

#### 限流

限流可以认为服务降级的一种，限流就是限制系统的输入和输出流量已达到保护系统的目的。一般来说系统的吞吐量是可以被测算的，为了保证系统的稳定运行，一旦达到的需要限制的阈值，就需要限制流量并采取一些措施以完成限制流量的目的。比如：延迟处理，拒绝处理，或者部分拒绝处理等等。

* 常见限流算法

1. 计数器

计数器是最简单粗暴的算法。比如某个服务最多只能每秒钟处理`100`个请求。我们可以设置一个1秒钟的滑动窗口，窗口中有`10`个格子，每个格子`100`毫秒，每`100`毫秒移动一次，每次移动都需要记录当前服务请求的次数。内存中需要保存`10`次的次数。可以用数据结构`LinkedList`来实现。格子每次移动的时候判断一次，当前访问次数和`LinkedList`中最后一个相差是否超过`100`，如果超过就需要限流了。

2. 漏桶算法

漏桶算法即`leaky bucket`是一种非常常用的限流算法，可以用来实现流量整形（`Traffic Shaping`）和流量控制（`Traffic Policing`）。

- 1) 一个固定容量的漏桶，按照常量固定速率流出水滴；
- 2) 如果桶是空的，则不需流出水滴；

- 3) 可以以任意速率流入水滴到漏桶；

- 4) 如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。

3. 令牌桶算法

令牌桶算法是一个存放固定容量令牌（`token`）的桶，按照固定速率往桶里添加令牌。

- 1) 令牌将按照固定的速率被放入令牌桶中。比如每秒放`10`个；

- 2) 桶中最多存放`b`个令牌，当桶满时，新添加的令牌被丢弃或拒绝；

- 3) 当一个`n`个字节大小的数据包到达，将从桶中删除`n`个令牌，接着数据包被发送到网络上；

- 4) 如果桶中的令牌不足`n`个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。

#### 容灾
* 雪崩
* 异地多活
#### 平滑启动
#### 主从设计
#### 分片模式
### 6.1.4 服务治理
#### 服务注册和发现
#### 路由控制
### 6.1.5 分布式一致
#### `CAP`理论和`BASE`理论
#### 分布式锁
#### 分布式一致方案
* 方案
* 一致性算法
* 唯一`ID`
#### 幂等
